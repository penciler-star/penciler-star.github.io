<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Linux驱动学习（二）" /><meta name="author" content="东三儿" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="一、前言" /><meta property="og:description" content="一、前言" /><link rel="canonical" href="/posts/post20230426/" /><meta property="og:url" content="/posts/post20230426/" /><meta property="og:site_name" content="东三儿" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-26T05:38:02+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Linux驱动学习（二）" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@东三儿" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"东三儿"},"dateModified":"2023-04-26T05:38:02+00:00","datePublished":"2023-04-26T05:38:02+00:00","description":"一、前言","headline":"Linux驱动学习（二）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/post20230426/"},"url":"/posts/post20230426/"}</script><title>Linux驱动学习（二） | 东三儿</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="东三儿"><meta name="application-name" content="东三儿"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">东三儿</a></div><div class="site-subtitle font-italic">这里是我的github博客～</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/penciler-star" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>Linux驱动学习（二）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Linux驱动学习（二）</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1682487482" data-df="YYYY/MM/DD" data-toggle="tooltip" data-placement="bottom"> 2023/04/26 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2082 字"> <em>11 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="一前言">一、前言</h1><p>续前章：Linux驱动学习（一）</p><p>学习参考网址：</p><p>https://embetronicx.com/tutorials/linux/</p><h1 id="二创建dev目录下的文件">二、创建/dev/目录下的文件</h1><p><strong>在使用insmod加载驱动后，应创建设备文件，以便系统能够访问此设备。</strong></p><p><strong>linux设备文件都存放在/dev/目录下。</strong></p><p>例如：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>crw--w---- 1 root <span class="nb">tty </span>4, 0 Aug 15 10:40 tty0
brw-rw---- 1 root disk 1, 0 Aug 15 10:40 ram0
</pre></table></code></div></div><h4 id="1手动创建设备文件"><span class="mr-2">1、手动创建设备文件</span><a href="#1手动创建设备文件" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>可以通过mknod手动创建设备文件：</strong></p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">mknod</span> <span class="nt">-m</span> &lt;permissions&gt; &lt;name&gt; &lt;device <span class="nb">type</span><span class="o">&gt;</span> &lt;major&gt; &lt;minor&gt;
</pre></table></code></div></div><p>-m &lt;<strong><code class="language-plaintext highlighter-rouge">permissions</code></strong>&gt; <em>–</em> optional argument that sets the permission bits of the new device file to <em>permissions</em></p><p><em>&lt;<strong><code class="language-plaintext highlighter-rouge">name</code></strong>&gt;</em> – your device file name that should have a full path (<strong><code class="language-plaintext highlighter-rouge">/dev/name</code></strong>)</p><p>&lt;<strong><em><code class="language-plaintext highlighter-rouge">device</code></em></strong>*<code class="language-plaintext highlighter-rouge"> type</code><strong>&gt;* – Put **c</strong> or <strong>b</strong></p><p>​ c – Character Device</p><p>​ b – Block Device</p><p>&lt;<strong><em><code class="language-plaintext highlighter-rouge">major</code></em></strong>&gt; – major number of your driver</p><p>&lt;<strong><em><code class="language-plaintext highlighter-rouge">minor</code></em></strong>&gt; – minor number of your driver</p><p>举个例子：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo mknod</span> <span class="nt">-m</span> 666 /dev/etx_device c 246 0
</pre></table></code></div></div><p><strong>可以通过rmmod进行删除设备文件</strong></p><h4 id="2自动创建设备文件"><span class="mr-2">2、自动创建设备文件</span><a href="#2自动创建设备文件" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>例程：create_file.c</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kdev_t.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/err.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/device.h&gt;</span><span class="cp">
</span><span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">;</span>
<span class="cm">/*Module init function*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hello_world_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*Automatically allocating Major number*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"new_Dev"</span><span class="p">))</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot allocate major number for device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Major = %d Minor = %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
 
        <span class="cm">/*Creating struct class*/</span>
        <span class="n">dev_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="s">"new_class"</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_class</span><span class="p">)){</span>
            <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot create the struct class for device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_class</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*Creating device*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device_create</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">"new_device"</span><span class="p">))){</span>
            <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot create the Device</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_device</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Kernel Module Inserted Successfully...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">r_device:</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="nl">r_class:</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*Module exit function*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hello_world_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">device_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Kernel Module Removed Successfully...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">hello_world_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hello_world_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Author"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"Automatically Creating a Device file"</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">"1:1.0"</span><span class="p">);</span>
</pre></table></code></div></div><p>进行make，然后insmod命令即可。</p><h1 id="三操作设备文件">三、操作设备文件</h1><p>创建设备文件后，用户需要操作这个文件，与设备进行通信。</p><p>那在这个文件中，就需要定义一组可以被调用的函数，完成通信任务。</p><p>例程：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kdev_t.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/err.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/cdev.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/device.h&gt;</span><span class="cp">
</span><span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">etx_cdev</span><span class="p">;</span>
<span class="cm">/*
** Function Prototypes
*/</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">__init</span> <span class="nf">etx_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__exit</span> <span class="nf">etx_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">etx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">etx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="nf">etx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span><span class="n">loff_t</span> <span class="o">*</span> <span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="nf">etx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span>      <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span>       <span class="o">=</span> <span class="n">etx_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span>      <span class="o">=</span> <span class="n">etx_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>       <span class="o">=</span> <span class="n">etx_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span>    <span class="o">=</span> <span class="n">etx_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cm">/*
** This function will be called when we open the Device file
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">etx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Driver Open Function Called...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we close the Device file
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">etx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Driver Release Function Called...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we read the Device file
*/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">etx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Driver Read Function Called...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we write the Device file
*/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">etx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Driver Write Function Called...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** Module Init function
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">etx_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*Allocating Major number*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"operate_Dev"</span><span class="p">))</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot allocate major number</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Major = %d Minor = %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
        <span class="cm">/*Creating cdev structure*/</span>
        <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fops</span><span class="p">);</span>
        <span class="cm">/*Adding character device to the system*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot add the device to the system</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_class</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*Creating struct class*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="s">"operate_class"</span><span class="p">))){</span>
            <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot create the struct class</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_class</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*Creating device*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device_create</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">"operate_device"</span><span class="p">))){</span>
            <span class="n">pr_err</span><span class="p">(</span><span class="s">"Cannot create the Device 1</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_device</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device Driver Insert...Done!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">r_device:</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="nl">r_class:</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** Module exit function
*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">etx_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">device_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
        <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">);</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device Driver Remove...Done!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">etx_driver_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">etx_driver_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Author"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"File Operations"</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">"1:1.3"</span><span class="p">);</span>
</pre></table></code></div></div><p>写makefile文件：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>obj-m +<span class="o">=</span> operate_driver.o


KDIR <span class="o">=</span> /lib/modules/<span class="si">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>/build


all:
  make <span class="nt">-C</span> <span class="si">$(</span>KDIR<span class="si">)</span>  <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>shell <span class="nb">pwd</span><span class="si">)</span> modules
 
clean:
  make <span class="nt">-C</span> <span class="si">$(</span>KDIR<span class="si">)</span>  <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>shell <span class="nb">pwd</span><span class="si">)</span> clean
</pre></table></code></div></div><p>load驱动文件：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>insmod
</pre></table></code></div></div><p>然后可以通过如下命令和刚刚写好的驱动程序进行通信：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>su
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo </span>1 <span class="o">&gt;</span> /dev/operate_device
</pre></table></code></div></div><h1 id="四实际创建一个可以读写的虚拟驱动">四、实际创建一个可以读写的虚拟驱动</h1><p>在完成上述所有步骤后，我们可以尝试自己创建一个驱动程序，此程序能够完成与用户态程序的通信，例如读写、打开关闭等操作。</p><p>在进行块数据的传输时，需要实现分配空间，并在用户态、内核态之间来回拷贝。</p><p>例如使用如下函数完成上述功能：</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;linux/slab.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;linux/uaccess.h&gt;</span><span class="cp">
</span><span class="kt">void</span> <span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">kfree</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">objp</span><span class="p">)</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">n</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">copy_to_user</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">n</span><span class="p">);</span>
</pre></table></code></div></div><p>我们利用如上函数，完成驱动程序：real_driver.c</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kdev_t.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/fs.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/cdev.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/device.h&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;linux/slab.h&gt;</span><span class="c1">                 //kmalloc()</span><span class="cp">
#include</span><span class="cpf">&lt;linux/uaccess.h&gt;</span><span class="c1">              //copy_to/from_user()</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/err.h&gt;</span><span class="cp">
</span>
<span class="cp">#define mem_size        1024           //Memory Size
</span>
<span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">dev_class</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">etx_cdev</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">kernel_buffer</span><span class="p">;</span>
<span class="cm">/*
** Function Prototypes
*/</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">__init</span> <span class="nf">etx_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">__exit</span> <span class="nf">etx_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">etx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="nf">etx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="nf">etx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span><span class="n">loff_t</span> <span class="o">*</span> <span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="nf">etx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">off</span><span class="p">);</span>
<span class="cm">/*
** File Operations structure
*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="p">.</span><span class="n">owner</span>          <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">read</span>           <span class="o">=</span> <span class="n">etx_read</span><span class="p">,</span>
        <span class="p">.</span><span class="n">write</span>          <span class="o">=</span> <span class="n">etx_write</span><span class="p">,</span>
        <span class="p">.</span><span class="n">open</span>           <span class="o">=</span> <span class="n">etx_open</span><span class="p">,</span>
        <span class="p">.</span><span class="n">release</span>        <span class="o">=</span> <span class="n">etx_release</span><span class="p">,</span>
<span class="p">};</span>
 
<span class="cm">/*
** This function will be called when we open the Device file
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">etx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device File Opened...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we close the Device file
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">etx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device File Closed...!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we read the Device file
*/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">etx_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">//Copy the data from the kernel space to the user-space</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">kernel_buffer</span><span class="p">,</span> <span class="n">mem_size</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Data Read : Err!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Data Read : Done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">mem_size</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** This function will be called when we write the Device file
*/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">etx_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
        <span class="c1">//Copy the data to kernel space from the user-space</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
                <span class="n">pr_err</span><span class="p">(</span><span class="s">"Data Write : Err!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Data Write : Done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** Module Init function
*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">etx_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*Allocating Major number*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"real_driver_Dev"</span><span class="p">))</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
                <span class="n">pr_info</span><span class="p">(</span><span class="s">"Cannot allocate major number</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Major = %d Minor = %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">MAJOR</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">MINOR</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
 
        <span class="cm">/*Creating cdev structure*/</span>
        <span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fops</span><span class="p">);</span>
 
        <span class="cm">/*Adding character device to the system*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">"Cannot add the device to the system</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_class</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="cm">/*Creating struct class*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span><span class="s">"real_driver_class"</span><span class="p">))){</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">"Cannot create the struct class</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_class</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="cm">/*Creating device*/</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">device_create</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">dev</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="s">"real_driver_device"</span><span class="p">))){</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">"Cannot create the Device 1</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_device</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/*Creating Physical memory*/</span>
        <span class="k">if</span><span class="p">((</span><span class="n">kernel_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mem_size</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">pr_info</span><span class="p">(</span><span class="s">"Cannot allocate memory in kernel</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">r_device</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="n">strcpy</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">,</span> <span class="s">"Hello_World"</span><span class="p">);</span>
        
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device Driver Insert...Done!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 
<span class="nl">r_device:</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
<span class="nl">r_class:</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
** Module exit function
*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">etx_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">kernel_buffer</span><span class="p">);</span>
        <span class="n">device_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">class_destroy</span><span class="p">(</span><span class="n">dev_class</span><span class="p">);</span>
        <span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">etx_cdev</span><span class="p">);</span>
        <span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">"Device Driver Remove...Done!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">etx_driver_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">etx_driver_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"Author"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"Real Linux Device Driver"</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">"1:1.4"</span><span class="p">);</span>
</pre></table></code></div></div><p>编写Makefile：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>obj-m +<span class="o">=</span> real_driver.o
 
KDIR <span class="o">=</span> /lib/modules/<span class="si">$(</span>shell <span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span>/build

 
all:
	make <span class="nt">-C</span> <span class="si">$(</span>KDIR<span class="si">)</span>  <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>shell <span class="nb">pwd</span><span class="si">)</span> modules
 
clean:
	make <span class="nt">-C</span> <span class="si">$(</span>KDIR<span class="si">)</span>  <span class="nv">M</span><span class="o">=</span><span class="si">$(</span>shell <span class="nb">pwd</span><span class="si">)</span> clean
</pre></table></code></div></div><p>随后利用如下命令进行load：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>insmod real_driver.ko
</pre></table></code></div></div><p>完成后，在用户空间编写如下C语言程序：test.c</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="kt">int8_t</span> <span class="n">write_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="kt">int8_t</span> <span class="n">read_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">option</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"*********************************</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/real_driver_device"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Cannot open device file...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"****Please Enter the Option******</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"        1. Write               </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"        2. Read                 </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"        3. Exit                 </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"*********************************</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">scanf</span><span class="p">(</span><span class="s">" %c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Your Option = %c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">option</span><span class="p">);</span>
                
                <span class="k">switch</span><span class="p">(</span><span class="n">option</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="sc">'1'</span><span class="p">:</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the string to write into driver :"</span><span class="p">);</span>
                                <span class="n">scanf</span><span class="p">(</span><span class="s">"  %[^</span><span class="se">\t\n</span><span class="s">]s"</span><span class="p">,</span> <span class="n">write_buf</span><span class="p">);</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Data Writing ..."</span><span class="p">);</span>
                                <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">write_buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">write_buf</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="sc">'2'</span><span class="p">:</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Data Reading ..."</span><span class="p">);</span>
                                <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">read_buf</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Done!</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Data = %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">read_buf</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="sc">'3'</span><span class="p">:</span>
                                <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="nl">default:</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">"Enter Valid option = %c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">option</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>随后进行编译：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gcc <span class="nt">-o</span> <span class="nb">test </span>test.c
</pre></table></code></div></div><p>运行test程序，即可查看结果。</p><p>卸载时，需要输入：</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sudu rmmod read_driver
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E7%BC%96%E7%A8%8B/'>编程</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Linux%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%20-%20%E4%B8%9C%E4%B8%89%E5%84%BF&url=%2Fposts%2Fpost20230426%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Linux%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%20-%20%E4%B8%9C%E4%B8%89%E5%84%BF&u=%2Fposts%2Fpost20230426%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fpost20230426%2F&text=Linux%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%20-%20%E4%B8%9C%E4%B8%89%E5%84%BF" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/post20230422/">Linux驱动学习（一）</a><li><a href="/posts/post20220924/">CUDA编程入门学习</a><li><a href="/posts/post20220426/">git学习</a><li><a href="/posts/post20220925/">Unity的简单入门</a><li><a href="/posts/post20191024/">Windows下安装Python+PCL</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deeplabcut/">DeepLabCut</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/cuda/">CUDA</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/gpu/">GPU</a> <a class="post-tag" href="/tags/matlab/">MATLAB</a> <a class="post-tag" href="/tags/opengl/">OpenGL</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/post20230422/"><div class="card-body"> <em class="small" data-ts="1682134982" data-df="YYYY/MM/DD" > 2023/04/22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux驱动学习（一）</h3><div class="text-muted small"><p> 一、前言 驱动程序是外界硬件设备、操作系统、用户之间通信的桥梁。 驱动程序基本上都是使用C语言完成，且处于内核空间。 现代Linux驱动程序基本都支持动态装载。 硬件设备主要分为：字符设备、块设备、网络设备，其驱动程序略有差别。 学习参考网址： https://embetronicx.com/tutorials/linux/ 二、第一个驱动程序 首先编写如下C程序。hello...</p></div></div></a></div><div class="card"> <a href="/posts/post202203291/"><div class="card-body"> <em class="small" data-ts="1648565290" data-df="YYYY/MM/DD" > 2022/03/29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ubuntu20下 Could not load dynamic library 'libcudnn.so.8'; dlerror libcudnn.so.8</h3><div class="text-muted small"><p> ubuntu20下 Could not load dynamic library ‘libcudnn.so.8’; dlerror: libcudnn.so.8: cannot open share 原因分析 是由于cudnn没有安装（可能安装了CUDA，但是没安cudnn） 解决方法 在cudnn官网上注册后，下载对应版本的cudnn，安装即可。 由于这里是ubuntu，故不需要使用...</p></div></div></a></div><div class="card"> <a href="/posts/post202203292/"><div class="card-body"> <em class="small" data-ts="1648569559" data-df="YYYY/MM/DD" > 2022/03/29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux下matlab出错</h3><div class="text-muted small"><p> linux 下 matlab 出错：Execution of script ** as a function is not supported 原因分析 1.有可能是因为当前matlab目录下存在多个同名文件，造成出错。 2.有可能因为当前运行环境中存在某个变量，与文件名或者函数名相同，造成出错。 3.windows下编译cpp生成的mexw64文件不能在linux环境下继续使用，造成出...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/post20230422/" class="btn btn-outline-primary" prompt="上一篇"><p>Linux驱动学习（一）</p></a> <a href="/posts/post20230427/" class="btn btn-outline-primary" prompt="下一篇"><p>GPU学习（一）</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/deeplabcut/">DeepLabCut</a> <a class="post-tag" href="/tags/opencv/">OpenCV</a> <a class="post-tag" href="/tags/cuda/">CUDA</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/git/">Git</a> <a class="post-tag" href="/tags/gpu/">GPU</a> <a class="post-tag" href="/tags/matlab/">MATLAB</a> <a class="post-tag" href="/tags/opengl/">OpenGL</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">penciler-star</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0">本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
